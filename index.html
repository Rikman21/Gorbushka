<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –î–ò–ó–ê–ô–ù V3.0 (Fixed Bottom Buttons) --- */
        :root {
            --bg-color: var(--tg-theme-bg-color, #f2f2f7);
            --text-color: var(--tg-theme-text-color, #000000);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #8e8e93);
            --danger: #ff3b30;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            /* –í–ê–ñ–ù–û: –î–µ–ª–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä—è—Ç–∞–ª—Å—è –∑–∞ –∫–Ω–æ–ø–∫–∞–º–∏ */
            padding: 16px 16px 100px 16px; 
            -webkit-tap-highlight-color: transparent;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .screen { transition: opacity 0.2s ease; opacity: 1; }
        .hidden { display: none !important; opacity: 0; }

        .header { 
            text-align: center; margin-bottom: 20px; 
            font-size: 22px; font-weight: 700; letter-spacing: -0.5px;
        }

        .card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            text-align: center; 
            margin-bottom: 20px;
        }

        /* --- –ù–ò–ñ–ù–Ø–Ø –ó–ê–ö–†–ï–ü–õ–ï–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ --- */
        .bottom-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            padding: 12px 16px 20px 16px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è iPhone */
            background: var(--card-bg);
            border-top: 0.5px solid var(--hint);
            display: flex;
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .main-btn { 
            width: 100%; padding: 14px; 
            border-radius: 12px; border: none; 
            font-size: 16px; font-weight: 600; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .main-btn:active { opacity: 0.7; transform: scale(0.98); }
        
        .btn-primary { background: var(--accent); color: var(--accent-text); }
        .btn-outline { background: transparent; color: var(--text-color); border: 1px solid var(--hint); }
        .btn-back { background: var(--bg-color); color: var(--text-color); width: 30%; font-size: 20px;} 

        /* –°–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ */
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-options .main-btn { margin-bottom: 0; height: 100%; text-align: center; font-size: 15px; border: 1px solid var(--hint); background: var(--card-bg); color: var(--text-color);}
        .full-width-opt { grid-column: span 2; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π */
        .offer-card { 
            background: var(--card-bg); 
            border-radius: 16px; padding: 16px; 
            margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .offer-price { font-size: 18px; font-weight: 700; }
        .offer-seller { font-size: 12px; color: var(--hint); }
        .btn-buy-small { 
            background: var(--accent); color: white; 
            border: none; padding: 8px 16px; 
            border-radius: 8px; font-weight: 600; font-size: 14px;
        }

        /* –í–≤–æ–¥ —Ü–µ–Ω—ã */
        .input-price { 
            width: 100%; padding: 10px; 
            font-size: 24px; font-weight: bold; 
            border: none; border-bottom: 2px solid var(--accent); 
            background: transparent; color: var(--text-color); 
            text-align: center; outline: none; margin: 20px 0;
        }

        .debug-box { font-size: 10px; color: var(--hint); text-align: center; margin-top: 10px; opacity: 0.5; }
        .admin-badge { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;}
    </style>
</head>
<body>
    <div id="app">
        
        <div id="screen-welcome" class="screen hidden">
            <h2 class="header">–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω</h2>
            <div class="card">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</p>
                <button class="main-btn btn-primary" style="margin-bottom:10px" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn btn-outline" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
            <div class="debug-box">ID: <span id="debug-id">...</span></div>
        </div>

        <div id="screen-lk" class="screen hidden">
            <h2 class="header" id="user-name">–ú–µ–Ω—é</h2>
            <div class="card">
                <button class="main-btn btn-primary" style="margin-bottom:10px" id="btn-buy" onclick="startFlow()">üîç –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                <button class="main-btn btn-primary" id="btn-price" onclick="startFlow()">üí∞ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É</button>
            </div>
            <button style="margin-top: 20px; background: transparent; color: var(--hint); border:none; width:100%" onclick="resetRole()">–í—ã–π—Ç–∏</button>
        </div>

        <div id="screen-flow" class="screen hidden">
            <h2 id="flow-title" class="header">–í—ã–±–æ—Ä</h2>
            <div id="flow-content" class="grid-options"></div>

            <div class="bottom-bar">
                <button class="main-btn btn-back" onclick="goBack()">‚¨Ö</button>
                <div style="width: 100%; display:flex; align-items:center; justify-content:center; color: var(--hint); font-size: 12px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
            </div>
        </div>

        <div id="screen-offers" class="screen hidden">
            <h2 class="header">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
            <div id="offers-list"></div>

            <div class="bottom-bar">
                <button class="main-btn btn-back" style="width: 100%" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É</button>
            </div>
        </div>

        <div id="screen-price" class="screen hidden">
            <h2 class="header">–í–∞—à–∞ —Ü–µ–Ω–∞</h2>
            <div class="card">
                <p id="price-product-name" style="color:var(--hint)"></p>
                <input type="number" id="price-input" class="input-price" placeholder="‚ÇΩ">
            </div>

            <div class="bottom-bar">
                <button class="main-btn btn-back" onclick="showScreen('screen-flow')">‚¨Ö</button>
                <button class="main-btn btn-primary" onclick="finishPrice()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // üìä –ö–ê–¢–ê–õ–û–ì (CSV)
        const csvData = `
iPhone 16e, 128 GB, Black, Dual Physical SIM
iPhone 16e, 256 GB, Black, Dual Physical SIM
iPhone 16e, 512 GB, Black, Dual Physical SIM
iPhone 16e, 128 GB, White, Dual Physical SIM
iPhone 16e, 256 GB, White, Dual Physical SIM
iPhone 16e, 512 GB, White, Dual Physical SIM
iPhone 16e, 128 GB, Black, Physical + eSIM
iPhone 16e, 256 GB, Black, Physical + eSIM
iPhone 16e, 512 GB, Black, Physical + eSIM
iPhone 16e, 128 GB, White, Physical + eSIM
iPhone 16e, 256 GB, White, Physical + eSIM
iPhone 16e, 512 GB, White, Physical + eSIM
iPhone 16, 128 GB, Black, Dual Physical SIM
iPhone 16, 256 GB, Black, Dual Physical SIM
iPhone 16, 512 GB, Black, Dual Physical SIM
iPhone 16, 128 GB, White, Dual Physical SIM
iPhone 16, 256 GB, White, Dual Physical SIM
iPhone 16, 512 GB, White, Dual Physical SIM
iPhone 16, 128 GB, Pink, Dual Physical SIM
iPhone 16, 256 GB, Pink, Dual Physical SIM
iPhone 16, 512 GB, Pink, Dual Physical SIM
iPhone 16, 128 GB, Teal, Dual Physical SIM
iPhone 16, 256 GB, Teal, Dual Physical SIM
iPhone 16, 512 GB, Teal, Dual Physical SIM
iPhone 16, 128 GB, Ultramarine, Dual Physical SIM
iPhone 16, 256 GB, Ultramarine, Dual Physical SIM
iPhone 16, 512 GB, Ultramarine, Dual Physical SIM
iPhone 16, 128 GB, Black, Physical + eSIM
iPhone 16, 256 GB, Black, Physical + eSIM
iPhone 16, 512 GB, Black, Physical + eSIM
iPhone 16, 128 GB, White, Physical + eSIM
iPhone 16, 256 GB, White, Physical + eSIM
iPhone 16, 512 GB, White, Physical + eSIM
iPhone 16, 128 GB, Pink, Physical + eSIM
iPhone 16, 256 GB, Pink, Physical + eSIM
iPhone 16, 512 GB, Pink, Physical + eSIM
iPhone 16, 128 GB, Teal, Physical + eSIM
iPhone 16, 256 GB, Teal, Physical + eSIM
iPhone 16, 512 GB, Teal, Physical + eSIM
iPhone 16, 128 GB, Ultramarine, Physical + eSIM
iPhone 16, 256 GB, Ultramarine, Physical + eSIM
iPhone 16, 512 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 128 GB, Black, Dual Physical SIM
iPhone 16 Plus, 256 GB, Black, Dual Physical SIM
iPhone 16 Plus, 512 GB, Black, Dual Physical SIM
iPhone 16 Plus, 128 GB, White, Dual Physical SIM
iPhone 16 Plus, 256 GB, White, Dual Physical SIM
iPhone 16 Plus, 512 GB, White, Dual Physical SIM
iPhone 16 Plus, 128 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 256 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 512 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 128 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 256 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 512 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 128 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 256 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 512 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 128 GB, Black, Physical + eSIM
iPhone 16 Plus, 256 GB, Black, Physical + eSIM
iPhone 16 Plus, 512 GB, Black, Physical + eSIM
iPhone 16 Plus, 128 GB, White, Physical + eSIM
iPhone 16 Plus, 256 GB, White, Physical + eSIM
iPhone 16 Plus, 512 GB, White, Physical + eSIM
iPhone 16 Plus, 128 GB, Pink, Physical + eSIM
iPhone 16 Plus, 256 GB, Pink, Physical + eSIM
iPhone 16 Plus, 512 GB, Pink, Physical + eSIM
iPhone 16 Plus, 128 GB, Teal, Physical + eSIM
iPhone 16 Plus, 256 GB, Teal, Physical + eSIM
iPhone 16 Plus, 512 GB, Teal, Physical + eSIM
iPhone 16 Plus, 128 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 256 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 512 GB, Ultramarine, Physical + eSIM
iPhone 16 Pro, 128 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, White Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Desert Titanium, Physical + eSIM
        `;

        const admins = [464896073, 210419]; 
        const sellers = [464896073]; 
        
        const urlParams = new URLSearchParams(window.location.search);
        let myId = urlParams.get('uid') ? parseInt(urlParams.get('uid')) : tg.initDataUnsafe.user?.id;
        document.getElementById('debug-id').innerText = myId || "–ù–ï –û–ü–†–ï–î–ï–õ–ï–ù";

        const catalogData = csvData.trim().split('\n').map(row => row.split(',').map(s => s.trim()));
        const headers = ["–ú–æ–¥–µ–ª—å", "–ü–∞–º—è—Ç—å", "–¶–≤–µ—Ç", "–°–∏–º-–∫–∞—Ä—Ç–∞"];

        let dbOffers = []; 
        try {
            const dataStr = urlParams.get('data');
            if (dataStr) dbOffers = JSON.parse(decodeURIComponent(dataStr));
        } catch (e) { console.error(e); }

        let currentSelection = [];
        let userRole = '';

        function init() {
            const role = localStorage.getItem('user_role');
            if(!role) showScreen('screen-welcome');
            else { userRole = role; updateInterface(role); showScreen('screen-lk'); }
        }

        function setRole(role) {
            const isAllowed = sellers.includes(myId) || admins.includes(myId);
            if(role === 'seller' && !isAllowed) return alert("‚õîÔ∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –í–∞—à ID: " + myId);
            localStorage.setItem('user_role', role);
            userRole = role;
            updateInterface(role);
            showScreen('screen-lk');
        }

        function resetRole() { localStorage.removeItem('user_role'); location.reload(); }

        function updateInterface(role) {
            const userName = tg.initDataUnsafe.user?.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            const isAdmin = admins.includes(myId);
            const badge = isAdmin ? ' <span class="admin-badge">ADMIN</span>' : '';
            document.getElementById('user-name').innerHTML = userName + badge;
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            document.getElementById('btn-price').style.display = (role === 'seller') ? 'block' : 'none';
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function startFlow() {
            currentSelection = [];
            renderStep(0);
            showScreen('screen-flow');
        }

        function goBack() {
            if (currentSelection.length > 0) {
                currentSelection.pop();
                renderStep(currentSelection.length);
            } else {
                showScreen('screen-lk');
            }
        }

        function renderStep(stepIndex) {
            if (stepIndex >= headers.length) {
                finishFlow();
                return;
            }

            document.getElementById('flow-title').innerText = headers[stepIndex];
            
            const availableOptions = new Set();
            catalogData.forEach(row => {
                let match = true;
                for(let i=0; i < stepIndex; i++) {
                    if (row[i] !== currentSelection[i]) match = false;
                }
                if (match) availableOptions.add(row[stepIndex]);
            });

            let h = '';
            Array.from(availableOptions).sort().forEach(opt => {
                const extraClass = opt.length > 15 ? 'full-width-opt' : '';
                h += `<button class="main-btn ${extraClass}" onclick="makeSelection('${opt}')">${opt}</button>`;
            });
            document.getElementById('flow-content').innerHTML = h;
        }

        function makeSelection(value) {
            currentSelection.push(value);
            renderStep(currentSelection.length);
        }

        function finishFlow() {
            const productName = currentSelection.join(' '); 
            document.getElementById('price-product-name').innerText = productName;
            if (userRole === 'buyer') renderOffers(productName);
            else showScreen('screen-price');
        }

        function renderOffers(productName) {
            let h = '';
            const relevantOffers = dbOffers.filter(o => o.product === productName);
            relevantOffers.sort((a,b)=>a.price-b.price);

            if (relevantOffers.length === 0) {
                h = '<div style="text-align:center; padding:40px; color:var(--hint);">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç üòî</div>';
            } else {
                relevantOffers.forEach(o => {
                    h += `
                    <div class="offer-card">
                        <div class="offer-info">
                            <div class="offer-price">${o.price.toLocaleString()} ‚ÇΩ</div>
                            <div class="offer-seller">@${o.username}</div>
                        </div>
                        <button class="btn-buy-small" onclick="requestBuy('${o.id}', '${o.username}', '${o.price}', '${productName}')">–ö—É–ø–∏—Ç—å</button>
                    </div>`;
                });
            }
            document.getElementById('offers-list').innerHTML = h;
            showScreen('screen-offers');
        }

        function requestBuy(sid, sname, price, pname) {
            tg.sendData(`REQ_BUY|${sid}|${sname}|${pname}|${price}`);
        }

        function finishPrice() {
            const p = document.getElementById('price-input').value;
            const pname = document.getElementById('price-product-name').innerText;
            if(!p) return alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");
            tg.sendData(`NEW_PRICE|${pname}|${p}`);
        }

        init();
    </script>
</body>
</html>
