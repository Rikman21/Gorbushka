<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f2f2f7; padding: 15px; color: #1c1c1e; }
        .hidden { display: none !important; }
        .header { text-align: center; margin-bottom: 15px; color: #007aff; font-size: 20px; font-weight: 600; }
        .card { background: white; border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .main-btn { padding: 18px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-yellow { background: #ffcc00; color: #000; }
        .btn-white { background: #fff; border: 1px solid #ddd; text-align: left; margin: 8px 0; display: block; }
        .back-btn { background: #ff3b30; color: white; margin-top: 15px; }
        
        /* –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å */
        .offer-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .offer-info { text-align: left; }
        .offer-price { font-size: 18px; font-weight: bold; color: #34c759; }
        .offer-seller { font-size: 12px; color: #8e8e93; }
        .btn-buy-small { background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .input-price { width: 90%; padding: 15px; font-size: 24px; border-radius: 10px; border: 2px solid #007aff; text-align: center; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="app">
        <div id="screen-welcome" class="hidden">
            <h2 class="header">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <div class="card">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</p>
                <button class="main-btn btn-yellow" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn btn-white" style="text-align:center" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
        </div>

        <div id="screen-lk" class="hidden">
            <div class="card">
                <div id="user-name">–õ–ö</div>
            </div>
            <button class="main-btn btn-yellow" id="btn-buy" onclick="startFlow('buy')">–ö—É–ø–∏—Ç—å</button>
            <button class="main-btn btn-yellow" id="btn-price" onclick="startFlow('sell')">–ú–æ–π –ü—Ä–∞–π—Å</button>
        </div>

        <div id="screen-flow" class="hidden">
            <h2 id="flow-title" class="header">–í—ã–±–æ—Ä</h2>
            <div id="flow-content"></div>
            <button class="main-btn back-btn" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-offers" class="hidden">
            <h2 class="header">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
            <div id="offers-list"></div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-price" class="hidden">
            <h2 class="header">–¶–µ–Ω–∞</h2>
            <div class="card">
                <p id="price-product-name"></p>
                <input type="number" id="price-input" class="input-price" placeholder="100000">
                <button class="main-btn btn-yellow" onclick="finishPrice()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // !!! 1. –í–ü–ò–®–ò–¢–ï –°–í–û–ô ID –°–Æ–î–ê !!!
        const sellers = [464896073]; 
        const myId = tg.initDataUnsafe.user?.id;

        // !!! 2. –í–ü–ò–®–ò–¢–ï –°–í–û–ô ID –í –ü–û–õ–ï 'id' !!!
        const mockOffers = [
            { id: 464896073, username: 'My_Store', price: 105000 },
            { id: 555555555, username: 'Rostov_Opt', price: 104000 }
        ];

        // –ö–ê–¢–ê–õ–û–ì (–°–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π –¥–ª—è —Ç–µ—Å—Ç–∞, –Ω–æ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
        const catalog = { 'iPhone': { 
            'iPhone 16 Pro': { mem: ['128','256'], col: ['Black','Desert'], net: ['2 Sim'] },
            'iPhone 15': { mem: ['128'], col: ['Blue'], net: ['1 Sim'] }
        }};

        let sel = { mode: '', cat: '', mod: '', mem: '', col: '', net: '', productName: '' };
        let history = [];

        function init() {
            const role = localStorage.getItem('user_role');
            if(!role) showScreen('screen-welcome');
            else { updateInterface(role); showScreen('screen-lk'); }
        }

        function setRole(role) {
            if(role === 'seller' && !sellers.includes(myId)) return alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –í–∞—à ID: " + myId);
            localStorage.setItem('user_role', role);
            updateInterface(role);
            showScreen('screen-lk');
        }

        function updateInterface(role) {
            document.getElementById('user-name').innerText = "–õ–ö: " + (tg.initDataUnsafe.user?.first_name || "User");
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            document.getElementById('btn-price').style.display = (role === 'seller') ? 'block' : 'none';
        }

        function showScreen(id) {
            ['screen-welcome', 'screen-lk', 'screen-flow', 'screen-offers', 'screen-price'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
        function startFlow(mode) { sel.mode = mode; history=['lk']; renderCats(); showScreen('screen-flow'); }
        function goBack() { showScreen('screen-lk'); }

        function renderCats() {
            let h = ''; for(let c in catalog) h+=`<button class="main-btn btn-white" onclick="selCat('${c}')">${c}</button>`;
            document.getElementById('flow-content').innerHTML = h;
        }
        function selCat(c) { sel.cat=c; renderMods(); }
        function renderMods() {
            let h = ''; for(let m in catalog[sel.cat]) h+=`<button class="main-btn btn-white" onclick="selMod('${m}')">${m}</button>`;
            document.getElementById('flow-content').innerHTML = h;
        }
        function selMod(m) { sel.mod=m; renderMem(); }
        function renderMem() {
             let h = ''; catalog[sel.cat][sel.mod].mem.forEach(m => h+=`<button class="main-btn btn-white" onclick="selMem('${m}')">${m} –ì–±</button>`);
             document.getElementById('flow-content').innerHTML = h;
        }
        function selMem(m) { sel.mem=m; renderCol(); }
        function renderCol() {
             let h = ''; catalog[sel.cat][sel.mod].col.forEach(c => h+=`<button class="main-btn btn-white" onclick="selCol('${c}')">${c}</button>`);
             document.getElementById('flow-content').innerHTML = h;
        }
        function selCol(c) { sel.col=c; finishFlow(); }

        function finishFlow() {
            sel.productName = `${sel.mod} ${sel.mem}Gb ${sel.col}`;
            if(sel.mode === 'buy') renderOffers();
            else {
                document.getElementById('price-product-name').innerText = sel.productName;
                showScreen('screen-price');
            }
        }

        function renderOffers() {
            let h = '';
            mockOffers.sort((a,b)=>a.price-b.price).forEach(o => {
                h += `
                <div class="offer-card">
                    <div class="offer-info">
                        <div class="offer-price">${o.price} ‚ÇΩ</div>
                        <div class="offer-seller">@${o.username}</div>
                    </div>
                    <button class="btn-buy-small" onclick="requestBuy('${o.id}', '${o.username}', '${o.price}')">–ö—É–ø–∏—Ç—å</button>
                </div>`;
            });
            document.getElementById('offers-list').innerHTML = h;
            showScreen('screen-offers');
        }

        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò ---
        function requestBuy(sid, sname, price) {
            const data = `REQ_BUY|${sid}|${sname}|${sel.productName}|${price}`;
            tg.sendData(data); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            // tg.close(); // –£–±—Ä–∞–ª–∏ close, —á—Ç–æ–±—ã –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ —É—à–ª–æ (–¢–µ–ª–µ–≥—Ä–∞–º —Å–∞–º –∑–∞–∫—Ä–æ–µ—Ç –∏–ª–∏ —Å–≤–µ—Ä–Ω–µ—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        }

        function finishPrice() {
            const p = document.getElementById('price-input').value;
            tg.sendData(`NEW_PRICE|${sel.productName}|${p}`);
        }

        init();
    </script>
</body>
</html>
