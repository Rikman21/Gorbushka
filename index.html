<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f2f2f7; padding: 15px; color: #1c1c1e; }
        .hidden { display: none !important; }
        .header { text-align: center; margin-bottom: 15px; color: #007aff; font-size: 20px; font-weight: 600; }
        .card { background: white; border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .main-btn { padding: 18px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-yellow { background: #ffcc00; color: #000; }
        .btn-white { background: #fff; border: 1px solid #ddd; text-align: left; margin: 8px 0; display: block; }
        .back-btn { background: #ff3b30; color: white; margin-top: 15px; }
        .btn-reset { background: transparent; color: #8e8e93; border: none; font-size: 14px; margin-top: 10px; cursor: pointer; text-decoration: underline; }

        /* –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å */
        .offer-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .offer-info { text-align: left; }
        .offer-price { font-size: 18px; font-weight: bold; color: #34c759; }
        .offer-seller { font-size: 12px; color: #8e8e93; }
        .btn-buy-small { background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .input-price { width: 90%; padding: 15px; font-size: 24px; border-radius: 10px; border: 2px solid #007aff; text-align: center; margin-bottom: 15px; }
        
        /* –ú–µ—Ç–∫–∞ –ê–¥–º–∏–Ω–∞ */
        .admin-badge { background: #ff3b30; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; vertical-align: middle; }
    </style>
</head>
<body>
    <div id="app">
        <div id="screen-welcome" class="hidden">
            <h2 class="header">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <div class="card">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:</p>
                <button class="main-btn btn-yellow" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn btn-white" style="text-align:center" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
        </div>

        <div id="screen-lk" class="hidden">
            <div class="card">
                <div id="user-name">–õ–ö</div>
                <button class="btn-reset" onclick="resetRole()">üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å (–í—ã–π—Ç–∏)</button>
            </div>
            
            <button class="main-btn btn-yellow" id="btn-buy" onclick="startFlow('buy')">–ö—É–ø–∏—Ç—å</button>
            <button class="main-btn btn-yellow" id="btn-price" onclick="startFlow('sell')">–ú–æ–π –ü—Ä–∞–π—Å</button>
        </div>

        <div id="screen-flow" class="hidden">
            <h2 id="flow-title" class="header">–í—ã–±–æ—Ä</h2>
            <div id="flow-content"></div>
            <button class="main-btn back-btn" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-offers" class="hidden">
            <h2 class="header">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
            <div id="offers-list"></div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-price" class="hidden">
            <h2 class="header">–¶–µ–Ω–∞</h2>
            <div class="card">
                <p id="price-product-name"></p>
                <input type="number" id="price-input" class="input-price" placeholder="100000">
                <button class="main-btn btn-yellow" onclick="finishPrice()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // --- ‚ö°Ô∏è –°–ü–ò–°–û–ö –ë–û–ì–û–í (–ê–î–ú–ò–ù–´) ‚ö°Ô∏è ---
        // –í–ø–∏—à–∏—Ç–µ —Å—é–¥–∞ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
        const admins = [464896073, 210419]; 

        // –û–±—ã—á–Ω—ã–µ –ø—Ä–æ–¥–∞–≤—Ü—ã
        const sellers = [464896073]; 
        
        const myId = tg.initDataUnsafe.user?.id;

        // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ (–ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–º —á—Ç–µ–Ω–∏–µ –∏–∑ –±–∞–∑—ã)
        const mockOffers = [
            { id: 464896073, username: 'My_Store', price: 105000 },
            { id: 555555555, username: 'Rostov_Opt', price: 104000 }
        ];

        const catalog = { 'iPhone': { 
            'iPhone 16 Pro': { mem: ['128','256'], col: ['Black','Desert'], net: ['2 Sim'] },
            'iPhone 15': { mem: ['128'], col: ['Blue'], net: ['1 Sim'] }
        }};

        let sel = { mode: '', cat: '', mod: '', mem: '', col: '', net: '', productName: '' };
        let history = [];

        function init() {
            const role = localStorage.getItem('user_role');
            if(!role) showScreen('screen-welcome');
            else { updateInterface(role); showScreen('screen-lk'); }
        }

        function setRole(role) {
            // –õ–û–ì–ò–ö–ê –î–û–°–¢–£–ü–ê:
            // –ü—É—Å–∫–∞–µ–º –µ—Å–ª–∏: –≠—Ç–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –ò–õ–ò (–≠—Ç–æ –ø—Ä–æ–¥–∞–≤–µ—Ü –ò (—Ç—ã –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –ò–õ–ò —Ç—ã –∞–¥–º–∏–Ω))
            const isSellerAllowed = sellers.includes(myId) || admins.includes(myId);
            
            if(role === 'seller' && !isSellerAllowed) {
                return alert("‚õîÔ∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í–∞—à ID: " + myId + "\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.");
            }
            
            localStorage.setItem('user_role', role);
            updateInterface(role);
            showScreen('screen-lk');
        }

        function resetRole() {
            localStorage.removeItem('user_role');
            location.reload();
        }

        function updateInterface(role) {
            const userName = tg.initDataUnsafe.user?.first_name || "User";
            const isAdmin = admins.includes(myId);
            
            // –ï—Å–ª–∏ –ê–¥–º–∏–Ω - –¥–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–æ–∫
            const badge = isAdmin ? ' <span class="admin-badge">ADMIN</span>' : '';
            document.getElementById('user-name').innerHTML = "–õ–ö: " + userName + badge;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            document.getElementById('btn-price').style.display = (role === 'seller') ? 'block' : 'none';
        }

        function showScreen(id) {
            ['screen-welcome', 'screen-lk', 'screen-flow', 'screen-offers', 'screen-price'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function startFlow(mode) { sel.mode = mode; history=['lk']; renderCats(); showScreen('screen-flow'); }
        function goBack() { showScreen('screen-lk'); }

        function renderCats() {
            let h = ''; for(let c in catalog) h+=`<button class="main-btn btn-white" onclick="selCat('${c}')">${c}</button>`;
            document.getElementById('flow-content').innerHTML = h;
        }
        function selCat(c) { sel.cat=c; renderMods(); }
        function renderMods() {
            let h = ''; for(let m in catalog[sel.cat]) h+=`<button class="main-btn btn-white" onclick="selMod('${m}')">${m}</button>`;
            document.getElementById('flow-content').innerHTML = h;
        }
        function selMod(m) { sel.mod=m; renderMem(); }
        function renderMem() {
             let h = ''; catalog[sel.cat][sel.mod].mem.forEach(m => h+=`<button class="main-btn btn-white" onclick="selMem('${m}')">${m} –ì–±</button>`);
             document.getElementById('flow-content').innerHTML = h;
        }
        function selMem(m) { sel.mem=m; renderCol(); }
        function renderCol() {
             let h = ''; catalog[sel.cat][sel.mod].col.forEach(c => h+=`<button class="main-btn btn-white" onclick="selCol('${c}')">${c}</button>`);
             document.getElementById('flow-content').innerHTML = h;
        }
        function selCol(c) { sel.col=c; finishFlow(); }

        function finishFlow() {
            sel.productName = `${sel.mod} ${sel.mem}Gb ${sel.col}`;
            if(sel.mode === 'buy') renderOffers();
            else {
                document.getElementById('price-product-name').innerText = sel.productName;
                showScreen('screen-price');
            }
        }

        function renderOffers() {
            let h = '';
            mockOffers.sort((a,b)=>a.price-b.price).forEach(o => {
                h += `
                <div class="offer-card">
                    <div class="offer-info">
                        <div class="offer-price">${o.price} ‚ÇΩ</div>
                        <div class="offer-seller">@${o.username}</div>
                    </div>
                    <button class="btn-buy-small" onclick="requestBuy('${o.id}', '${o.username}', '${o.price}')">–ö—É–ø–∏—Ç—å</button>
                </div>`;
            });
            document.getElementById('offers-list').innerHTML = h;
            showScreen('screen-offers');
        }

        function requestBuy(sid, sname, price) {
            const data = `REQ_BUY|${sid}|${sname}|${sel.productName}|${price}`;
            tg.sendData(data);
        }

        function finishPrice() {
            const p = document.getElementById('price-input').value;
            tg.sendData(`NEW_PRICE|${sel.productName}|${p}`);
        }

        init();
    </script>
</body>
</html>
