<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –°–¢–ò–õ–ò (–î–∏–∑–∞–π–Ω V7.0 - Live Data) --- */
        :root {
            --bg-color: var(--tg-theme-bg-color, #f2f2f7);
            --text-color: var(--tg-theme-text-color, #000000);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #8e8e93);
            --danger: #ff3b30;
            --success: #34c759;
            --overlay: rgba(0,0,0,0.4);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 16px 16px 120px 16px; 
            -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .screen.active { display: block; opacity: 1; }
        
        /* –õ–æ–∞–¥–µ—Ä */
        #loader {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--hint);
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header { text-align: center; margin-bottom: 20px; font-size: 22px; font-weight: 700; }

        .card { 
            background: var(--card-bg); border-radius: 16px; padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px;
        }

        .main-btn { 
            width: 100%; padding: 14px; border-radius: 12px; border: none; 
            font-size: 16px; font-weight: 600; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; 
            background: var(--card-bg); color: var(--text-color); border: 1px solid var(--hint);
        }
        .btn-primary { background: var(--accent); color: var(--accent-text); border: none;}
        .btn-excel { background: var(--success); color: white; border: none; } 
        .btn-back { background: var(--bg-color); color: var(--text-color); width: 30%; font-size: 22px; margin-bottom: 0; border:none;} 
        .folder-btn { justify-content: space-between; padding: 16px 20px; text-align: left; }
        .folder-arrow { color: var(--hint); font-size: 14px; }
        .list-options { display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }

        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0; padding: 12px 16px 30px 16px; 
            background: var(--card-bg); border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex; gap: 10px; z-index: 1000;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05); backdrop-filter: blur(10px); 
        }

        .offer-card { 
            background: var(--card-bg); border-radius: 16px; padding: 16px; 
            margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
            opacity: 0; animation: popIn 0.3s ease forwards;
        }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .offer-info { text-align: left; max-width: 70%;}
        .offer-name { font-weight:600; font-size:14px; margin-bottom:4px; line-height: 1.2; }
        .offer-price { font-size: 17px; font-weight: 700; color: var(--accent); }
        .offer-seller { font-size: 12px; color: var(--hint); }
        .btn-buy-small { 
            background: var(--accent); color: white; border: none; padding: 8px 16px; 
            border-radius: 8px; font-weight: 600; font-size: 14px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--overlay); z-index: 2000;
            display: flex; align-items: flex-end; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: var(--bg-color); width: 100%; 
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 24px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding-bottom: 50px;
        }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
        .input-edit { 
            width: 100%; padding: 12px; font-size: 20px; border-radius: 12px;
            border: 1px solid var(--hint); outline: none; text-align: center; box-sizing: border-box; background: var(--card-bg); color: var(--text-color);
        }
        .btn-modal-delete { background: var(--danger); color: white; flex: 1; border:none; padding: 14px; border-radius: 12px; font-weight: 600;}
        .btn-modal-save { background: var(--accent); color: white; flex: 1; border:none; padding: 14px; border-radius: 12px; font-weight: 600;}

        .debug-box { font-size: 10px; color: var(--hint); text-align: center; margin-top: 10px; opacity: 0.5; }
        .admin-badge { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;}
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω...</div>
    </div>

    <div id="app">
        
        <div id="screen-welcome" class="screen">
            <h2 class="header">–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω üì±</h2>
            <div class="card">
                <p style="margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</p>
                <button class="main-btn btn-primary" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn btn-outline" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
            <div class="debug-box">ID: <span id="debug-id">...</span></div>
        </div>

        <div id="screen-lk" class="screen">
            <h2 class="header" id="user-name">–ú–µ–Ω—é</h2>
            <div class="card">
                <button class="main-btn btn-primary" id="btn-buy" onclick="startFlow()">üîç –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                <button class="main-btn btn-outline" id="btn-my-offers" onclick="goToMyCategories()">üìã –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</button>
                <button class="main-btn btn-excel" id="btn-template" onclick="requestTemplate()">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω (Excel)</button>
            </div>
            <button style="margin-top: 20px; background: transparent; color: var(--danger); border:none; width:100%; font-size:14px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:5px;" onclick="resetRole()">üö™ –í—ã–π—Ç–∏ (–°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å)</button>
        </div>

        <div id="screen-flow" class="screen">
            <h2 id="flow-title" class="header">–í—ã–±–æ—Ä</h2>
            <div id="flow-content" class="list-options"></div> 
            <div class="bottom-bar">
                <button class="main-btn btn-back" onclick="goBack()">‚¨ÖÔ∏è</button>
                <div style="width: 100%; display:flex; align-items:center; justify-content:center; color: var(--hint); font-size: 12px;">–®–∞–≥ –Ω–∞–∑–∞–¥</div>
            </div>
        </div>

        <div id="screen-offers" class="screen">
            <h2 class="header">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è üìã</h2>
            <div id="offers-list"></div>
            <div class="bottom-bar">
                <button class="main-btn btn-back" style="width: 100%" onclick="showScreen('screen-flow')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</button>
            </div>
        </div>

        <div id="screen-my-categories" class="screen">
            <h2 class="header">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ üì¶</h2>
            <div class="list-options">
                <button class="main-btn folder-btn" onclick="goToMyFamilies('iPhone')">
                    <span>üì± iPhone</span> <span class="folder-arrow">‚Ä∫</span>
                </button>
                <button class="main-btn folder-btn" style="opacity:0.5" onclick="alert('–°–∫–æ—Ä–æ!')">
                    <span>üíª Mac (–°–∫–æ—Ä–æ)</span> <span class="folder-arrow">‚Ä∫</span>
                </button>
                <button class="main-btn folder-btn" style="opacity:0.5" onclick="alert('–°–∫–æ—Ä–æ!')">
                    <span>‚åöÔ∏è Watch (–°–∫–æ—Ä–æ)</span> <span class="folder-arrow">‚Ä∫</span>
                </button>
            </div>
            <div class="bottom-bar">
                <button class="main-btn btn-back" style="width: 100%" onclick="showScreen('screen-lk')">‚¨ÖÔ∏è –í –º–µ–Ω—é</button>
            </div>
        </div>

        <div id="screen-my-families" class="screen">
            <h2 class="header">–ú–æ–¥–µ–ª–∏</h2>
            <div id="family-list" class="list-options"></div>
            <div class="bottom-bar">
                <button class="main-btn btn-back" style="width: 100%" onclick="showScreen('screen-my-categories')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
            </div>
        </div>

        <div id="screen-my-list" class="screen">
            <h2 class="header" id="my-list-title">–¢–æ–≤–∞—Ä—ã</h2>
            <div id="my-items-list" style="padding-bottom: 20px;"></div>
            <div class="bottom-bar">
                <button class="main-btn btn-back" style="width: 100%" onclick="showScreen('screen-my-families')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
            </div>
        </div>

    </div>

    <div id="modal-edit" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–º</div>
            <p id="modal-product-name" style="text-align:center; color:var(--hint); margin-bottom:15px; font-size:14px;"></p>
            <input type="number" id="modal-price-input" class="input-edit" placeholder="–ù–æ–≤–∞—è —Ü–µ–Ω–∞">
            <div class="modal-actions">
                <button class="btn-modal-delete" onclick="actionDelete()">–£–¥–∞–ª–∏—Ç—å üóë</button>
                <button class="btn-modal-save" onclick="actionSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å üíæ</button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // ‚ö†Ô∏è –ó–î–ï–°–¨ –ê–î–†–ï–° –í–ê–®–ï–ì–û –ë–û–¢–ê –ù–ê RENDER ‚ö†Ô∏è
        const BACKEND_URL = "https://gorbushka.onrender.com";

        const csvData = `
iPhone 16e, 128 GB, Black, Dual Physical SIM
iPhone 16e, 256 GB, Black, Dual Physical SIM
iPhone 16e, 512 GB, Black, Dual Physical SIM
iPhone 16e, 128 GB, White, Dual Physical SIM
iPhone 16e, 256 GB, White, Dual Physical SIM
iPhone 16e, 512 GB, White, Dual Physical SIM
iPhone 16e, 128 GB, Black, Physical + eSIM
iPhone 16e, 256 GB, Black, Physical + eSIM
iPhone 16e, 512 GB, Black, Physical + eSIM
iPhone 16e, 128 GB, White, Physical + eSIM
iPhone 16e, 256 GB, White, Physical + eSIM
iPhone 16e, 512 GB, White, Physical + eSIM
iPhone 16, 128 GB, Black, Dual Physical SIM
iPhone 16, 256 GB, Black, Dual Physical SIM
iPhone 16, 512 GB, Black, Dual Physical SIM
iPhone 16, 128 GB, White, Dual Physical SIM
iPhone 16, 256 GB, White, Dual Physical SIM
iPhone 16, 512 GB, White, Dual Physical SIM
iPhone 16, 128 GB, Pink, Dual Physical SIM
iPhone 16, 256 GB, Pink, Dual Physical SIM
iPhone 16, 512 GB, Pink, Dual Physical SIM
iPhone 16, 128 GB, Teal, Dual Physical SIM
iPhone 16, 256 GB, Teal, Dual Physical SIM
iPhone 16, 512 GB, Teal, Dual Physical SIM
iPhone 16, 128 GB, Ultramarine, Dual Physical SIM
iPhone 16, 256 GB, Ultramarine, Dual Physical SIM
iPhone 16, 512 GB, Ultramarine, Dual Physical SIM
iPhone 16, 128 GB, Black, Physical + eSIM
iPhone 16, 256 GB, Black, Physical + eSIM
iPhone 16, 512 GB, Black, Physical + eSIM
iPhone 16, 128 GB, White, Physical + eSIM
iPhone 16, 256 GB, White, Physical + eSIM
iPhone 16, 512 GB, White, Physical + eSIM
iPhone 16, 128 GB, Pink, Physical + eSIM
iPhone 16, 256 GB, Pink, Physical + eSIM
iPhone 16, 512 GB, Pink, Physical + eSIM
iPhone 16, 128 GB, Teal, Physical + eSIM
iPhone 16, 256 GB, Teal, Physical + eSIM
iPhone 16, 512 GB, Teal, Physical + eSIM
iPhone 16, 128 GB, Ultramarine, Physical + eSIM
iPhone 16, 256 GB, Ultramarine, Physical + eSIM
iPhone 16, 512 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 128 GB, Black, Dual Physical SIM
iPhone 16 Plus, 256 GB, Black, Dual Physical SIM
iPhone 16 Plus, 512 GB, Black, Dual Physical SIM
iPhone 16 Plus, 128 GB, White, Dual Physical SIM
iPhone 16 Plus, 256 GB, White, Dual Physical SIM
iPhone 16 Plus, 512 GB, White, Dual Physical SIM
iPhone 16 Plus, 128 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 256 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 512 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 128 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 256 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 512 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 128 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 256 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 512 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 128 GB, Black, Physical + eSIM
iPhone 16 Plus, 256 GB, Black, Physical + eSIM
iPhone 16 Plus, 512 GB, Black, Physical + eSIM
iPhone 16 Plus, 128 GB, White, Physical + eSIM
iPhone 16 Plus, 256 GB, White, Physical + eSIM
iPhone 16 Plus, 512 GB, White, Physical + eSIM
iPhone 16 Plus, 128 GB, Pink, Physical + eSIM
iPhone 16 Plus, 256 GB, Pink, Physical + eSIM
iPhone 16 Plus, 512 GB, Pink, Physical + eSIM
iPhone 16 Plus, 128 GB, Teal, Physical + eSIM
iPhone 16 Plus, 256 GB, Teal, Physical + eSIM
iPhone 16 Plus, 512 GB, Teal, Physical + eSIM
iPhone 16 Plus, 128 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 256 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 512 GB, Ultramarine, Physical + eSIM
iPhone 16 Pro, 128 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, White Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Desert Titanium, Physical + eSIM
        `;

        // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–ò ID ‚ö†Ô∏è
        const admins = [464896073, 210419]; 
        const sellers = [464896073, 210419]; 
        
        const urlParams = new URLSearchParams(window.location.search);
        let myId = urlParams.get('uid') ? parseInt(urlParams.get('uid')) : tg.initDataUnsafe.user?.id;
        document.getElementById('debug-id').innerText = myId || "–ù–ï –û–ü–†–ï–î–ï–õ–ï–ù";

        const catalogData = csvData.trim().split('\n').map(row => row.split(',').map(s => s.trim()));
        const headers = ["üì± –ú–æ–¥–µ–ª—å", "üíæ –ü–∞–º—è—Ç—å", "üé® –¶–≤–µ—Ç", "üì≤ –°–∏–º-–∫–∞—Ä—Ç–∞"];

        let dbOffers = []; 
        let currentSelection = [];
        let userRole = '';
        let currentEditingSku = null; 

        // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò
        async function init() {
            try {
                // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
                document.getElementById('loader').style.display = 'flex';
                
                // 2. –°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
                const response = await fetch(`${BACKEND_URL}/api/offers`);
                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                dbOffers = await response.json();
                
                console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:", dbOffers.length);
            } catch (e) {
                console.error(e);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ü–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
            } finally {
                // 3. –£–±–∏—Ä–∞–µ–º –ª–æ–∞–¥–µ—Ä
                document.getElementById('loader').style.display = 'none';
            }

            // 4. –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞
            const role = localStorage.getItem('user_role');
            if(!role) showScreen('screen-welcome');
            else { userRole = role; updateInterface(role); showScreen('screen-lk'); }
        }

        function setRole(role) {
            const isAllowed = sellers.includes(myId) || admins.includes(myId);
            if(role === 'seller' && !isAllowed) return alert("‚õîÔ∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.");
            localStorage.setItem('user_role', role);
            userRole = role;
            updateInterface(role);
            showScreen('screen-lk');
        }

        function resetRole() { localStorage.removeItem('user_role'); location.reload(); }

        function updateInterface(role) {
            const userName = tg.initDataUnsafe.user?.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            const isAdmin = admins.includes(myId);
            const badge = isAdmin ? ' <span class="admin-badge">ADMIN</span>' : '';
            document.getElementById('user-name').innerHTML = userName + badge;
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            
            if (role === 'seller') {
                document.getElementById('btn-template').style.display = 'block';
                document.getElementById('btn-my-offers').style.display = 'block';
            } else {
                document.getElementById('btn-template').style.display = 'none';
                document.getElementById('btn-my-offers').style.display = 'none';
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            window.scrollTo(0,0);
            document.getElementById(id).classList.add('active');
        }

        function requestTemplate() { tg.sendData("REQ_TEMPLATE"); }

        function startFlow() { currentSelection = []; renderStep(0); showScreen('screen-flow'); }
        function goBack() { 
            if (currentSelection.length > 0) { currentSelection.pop(); renderStep(currentSelection.length); } 
            else { showScreen('screen-lk'); }
        }

        function renderStep(stepIndex) {
            if (stepIndex >= headers.length) { finishFlow(); return; }
            document.getElementById('flow-title').innerText = headers[stepIndex];
            
            const availableOptions = new Set();
            catalogData.forEach(row => {
                let match = true;
                for(let i=0; i < stepIndex; i++) { if (row[i] !== currentSelection[i]) match = false; }
                if (match) availableOptions.add(row[stepIndex]);
            });

            let h = '';
            Array.from(availableOptions).sort().forEach((opt, index) => {
                const delay = index * 0.05; 
                h += `<button class="main-btn btn-outline" style="animation-delay: ${delay}s" onclick="makeSelection('${opt}')">${opt}</button>`;
            });
            document.getElementById('flow-content').innerHTML = h;
        }

        function makeSelection(value) { currentSelection.push(value); renderStep(currentSelection.length); }
        function finishFlow() {
            const productName = currentSelection.join(' '); 
            if (userRole === 'buyer') renderOffers(productName);
            // –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–≤–µ—Ü - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ—Ç—É, —Ç.–∫. —Ä—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–∏–ª–∏
            else alert("–†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Excel.");
        }

        function renderOffers(productName) {
            let h = '';
            const relevantOffers = dbOffers.filter(o => o.product === productName);
            relevantOffers.sort((a,b)=>a.price-b.price);
            if (relevantOffers.length === 0) h = '<div style="text-align:center; padding:40px; color:var(--hint);">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç üòî</div>';
            else {
                relevantOffers.forEach((o, index) => {
                    const delay = index * 0.1;
                    h += `
                    <div class="offer-card" style="animation-delay: ${delay}s">
                        <div class="offer-info">
                            <div class="offer-price">${o.price.toLocaleString()} ‚ÇΩ</div>
                            <div class="offer-seller">@${o.username}</div>
                        </div>
                        <button class="btn-buy-small" onclick="requestBuy('${o.id}', '${o.username}', '${o.price}', '${productName}')">üõçÔ∏è –ö—É–ø–∏—Ç—å</button>
                    </div>`;
                });
            }
            document.getElementById('offers-list').innerHTML = h;
            showScreen('screen-offers');
        }

        // --- –õ–û–ì–ò–ö–ê "–ú–û–ò –¢–û–í–ê–†–´" ---
        function goToMyCategories() { showScreen('screen-my-categories'); }

        function goToMyFamilies(category) {
            const myOffers = dbOffers.filter(o => o.seller_id === myId);
            if(myOffers.length === 0) return alert("–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å —á–µ—Ä–µ–∑ Excel.");

            const families = new Set();
            myOffers.forEach(o => {
                const parts = o.product.split(' ');
                if(parts.length >= 2) families.add(parts[0] + ' ' + parts[1]);
            });

            let h = '';
            h += `<button class="main-btn folder-btn" style="background:var(--accent); color:white;" onclick="goToMyList('ALL')">üìë –í–ï–°–¨ –°–ü–ò–°–û–ö</button>`;
            
            Array.from(families).sort().reverse().forEach((fam, index) => {
                h += `<button class="main-btn folder-btn" onclick="goToMyList('${fam}')">
                        <span>üì± ${fam} Series</span> <span class="folder-arrow">‚Ä∫</span>
                      </button>`;
            });

            document.getElementById('family-list').innerHTML = h;
            showScreen('screen-my-families');
        }

        function goToMyList(filter) {
            const myOffers = dbOffers.filter(o => o.seller_id === myId);
            let filtered = (filter === 'ALL') ? myOffers : myOffers.filter(o => o.product.startsWith(filter));
            
            document.getElementById('my-list-title').innerText = (filter === 'ALL') ? "–í—Å–µ —Ç–æ–≤–∞—Ä—ã" : filter;

            let h = '';
            filtered.sort((a,b) => a.product.localeCompare(b.product));

            filtered.forEach((o, index) => {
                const delay = index * 0.05;
                const shortName = o.product.replace("iPhone ", ""); 
                h += `
                <div class="offer-card" style="animation-delay: ${delay}s" onclick="openModal('${o.sku}', '${o.price}', '${o.product}')">
                    <div class="offer-info">
                        <div class="offer-name">${shortName}</div>
                        <div class="offer-seller">SKU: ${o.sku}</div>
                    </div>
                    <div class="offer-price">${o.price.toLocaleString()} ‚ÇΩ</div>
                </div>`;
            });
            document.getElementById('my-items-list').innerHTML = h;
            showScreen('screen-my-list');
        }

        // --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ---
        function openModal(sku, price, name) {
            currentEditingSku = sku;
            document.getElementById('modal-product-name').innerText = name;
            document.getElementById('modal-price-input').value = price;
            document.getElementById('modal-edit').classList.add('open');
        }

        function closeModal(e) {
            if (e.target.id === 'modal-edit') document.getElementById('modal-edit').classList.remove('open');
        }

        function actionDelete() {
            if(!currentEditingSku) return;
            if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?")) {
                tg.sendData(`DELETE_OFFER|${currentEditingSku}`);
                document.getElementById('modal-edit').classList.remove('open');
                // –£–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (–¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã)
                dbOffers = dbOffers.filter(o => o.sku !== currentEditingSku);
                alert("–£–¥–∞–ª–µ–Ω–æ! (–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É–±–µ–¥–∏—Ç—å—Å—è)");
                showScreen('screen-lk');
            }
        }

        function actionSave() {
            if(!currentEditingSku) return;
            const newPrice = document.getElementById('modal-price-input').value;
            if(!newPrice) return alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");
            const name = document.getElementById('modal-product-name').innerText;
            tg.sendData(`NEW_PRICE|${name}|${newPrice}`); 
            document.getElementById('modal-edit').classList.remove('open');
        }

        function requestBuy(sid, sname, price, pname) { tg.sendData(`REQ_BUY|${sid}|${sname}|${pname}|${price}`); }

        init();
    </script>
</body>
</html>
