<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
               background-color: #f2f2f7; padding: 15px; color: #1c1c1e; }
        
        /* –°—Ç–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .header { text-align: center; margin-bottom: 15px; color: #007aff; font-size: 20px; font-weight: 600; }
        .card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .balance { font-size: 32px; font-weight: bold; margin: 10px 0; color: #000; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .main-btn { padding: 18px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-yellow { background: #ffcc00; color: #000; }
        .btn-white { background: #fff; border: 1px solid #ddd; text-align: left; margin: 8px 0; width: 100%; display: block; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-white:active { background: #e5e5ea; }
        .back-btn { background: #ff3b30; color: white; width: 100%; margin-top: 15px; }
        
        /* –í–∫–ª–∞–¥–∫–∏ (tabs) */
        .tabs { display: flex; overflow-x: auto; background: white; border-radius: 10px; padding: 5px; margin-top: 20px; gap: 5px; }
        .tab { font-size: 13px; padding: 10px 15px; color: #1c1c1e; cursor: pointer; border: 1px solid #ddd; border-radius: 5px; white-space: nowrap; flex: 1; text-align: center; }
        .tab.active { background: #e5e5ea; font-weight: bold; border-color: #ff3b30; }

        /* –°–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫ */
        .deal-item { background: #34c759; color: white; padding: 12px; border-radius: 8px; margin-top: 8px; font-size: 12px; text-align: left; }
        
        /* –ü—Ä–∞–≤–∏–ª–∞ */
        .rules-list { text-align: left; font-size: 13px; color: #333; line-height: 1.4; background: #fffbe6; padding: 15px; border-radius: 10px; border: 1px solid #ffe58f; margin-top: 10px; }
        .rules-list li { margin-bottom: 8px; }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ü–µ–Ω—ã */
        .input-price { width: 90%; padding: 15px; font-size: 24px; border-radius: 10px; border: 2px solid #007aff; text-align: center; margin-bottom: 15px; outline: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="app">
        <div id="screen-welcome" class="hidden">
            <h2 class="header">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <div class="card">
                <p style="color: #8e8e93; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Å—Ç–∞—Ç—É—Å –≤ —Å–∏—Å—Ç–µ–º–µ:</p>
                <button class="main-btn btn-yellow" style="width:100%; margin-bottom:10px;" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn btn-white" style="width:100%; text-align:center;" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
        </div>

        <div id="screen-lk" class="hidden">
            <div class="card">
                <div id="user-name" style="color: #8e8e93; font-size: 14px;">–õ–ö - –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="balance">100 000—Ä</div>
            </div>
            <div class="grid">
                <button id="btn-buy" class="main-btn btn-yellow" onclick="startFlow('buy')">–ö—É–ø–∏—Ç—å</button>
                <button id="btn-price" class="main-btn btn-yellow" onclick="startFlow('sell')">–ú–æ–π –ü—Ä–∞–π—Å</button>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab(this)">—Å–¥–µ–ª–∫–∏</div>
                <div class="tab" onclick="switchTab(this)">–∞–∫—Ç–∏–≤–Ω—ã–µ</div>
                <div class="tab" onclick="switchTab(this)">–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</div>
                <div class="tab" onclick="switchTab(this)">–∞—É–∫—Ü–∏–æ–Ω</div>
            </div>
            <div id="deals-list">
                <div class="deal-item">–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ –ø—É—Å—Ç–∞</div>
            </div>
        </div>

        <div id="screen-flow" class="hidden">
            <h2 id="flow-title" class="header">–í—ã–±–æ—Ä</h2>
            <div id="flow-content"></div>
            <button class="main-btn back-btn" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-confirm" class="hidden">
            <h2 class="header">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            <div class="card">
                <p id="summary-text" style="font-weight:bold; font-size:16px; color:#007aff; margin-bottom:15px;"></p>
                
                <div class="rules-list">
                    <p style="font-weight:bold; margin-top:0;">‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–∞ —Å–¥–µ–ª–∫–∏:</p>
                    <ul style="padding-left: 20px; margin:0;">
                        <li>–ù–µ —Å–ø–∞–º–∏—Ç—å (1 –∑–∞–ø—Ä–æ—Å –≤ 5 –º–∏–Ω).</li>
                        <li>–°–æ–±–ª—é–¥–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.</li>
                        <li>–ó–∞–ø—Ä–µ—â–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ —Ü–µ–ª–∏ –∫—É–ø–∏—Ç—å.</li>
                        <li>–ë–∞–Ω –Ω–∞ 1 –¥–µ–Ω—å –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è.</li>
                    </ul>
                </div>
                
                <button class="main-btn btn-yellow" style="width:100%; margin-top:15px;" onclick="finalSubmit()">–°–æ–≥–ª–∞—Å–µ–Ω –∏ –∑–∞–∫–∞–∑–∞—Ç—å</button>
            </div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-price" class="hidden">
            <h2 class="header">–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É</h2>
            <div class="card">
                <p id="price-product-name" style="font-weight:bold; font-size:14px; margin-bottom:10px;"></p>
                <input type="number" id="price-input" class="input-price" placeholder="100000">
                <p style="color: #8e8e93; font-size:12px;">–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö</p>
                <button class="main-btn btn-yellow" style="width:100%" onclick="finishPrice()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // -------------------------------------------------------------
        // 1. –ù–ê–°–¢–†–û–ô–ö–ò (–í–ø–∏—à–∏—Ç–µ —Å–≤–æ–π ID –Ω–∏–∂–µ –≤–º–µ—Å—Ç–æ 123456789)
        // -------------------------------------------------------------
        const sellers = [123456789]; 
        
        // –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤
        const catalog = {
            'iPhone': {
                'iPhone 16 Pro Max': { mem: ['256','512','1TB'], col: ['Black','Silver','Desert'], net: ['Sim + eSim', '2 Sim', 'eSim Only'] },
                'iPhone 16 Pro': { mem: ['128','256','512'], col: ['Black','Silver','Desert'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 16 Plus': { mem: ['128','256'], col: ['Black','Blue','Pink'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 16': { mem: ['128','256','512'], col: ['Black','Blue','Pink'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 15': { mem: ['128','256'], col: ['Black','Blue','Yellow'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 14': { mem: ['128','256'], col: ['Black','Purple','Blue'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 13': { mem: ['128','256'], col: ['Midnight','Starlight','Blue'], net: ['1 Sim'] },
                'iPhone 12 / 12 mini': { mem: ['64','128','256'], col: ['Black','White','Blue'], net: ['1 Sim'] },
                'iPhone 11': { mem: ['64','128'], col: ['Black','Silver'], net: ['1 Sim'] },
                'iPhone SE': { mem: ['64','128'], col: ['Midnight','Red'], net: ['1 Sim'] }
            },
            'iPad': { 
                'iPad Pro M4': { mem: ['256','512'], col: ['Space Gray','Silver'], net: ['Wi-Fi', 'Wi-Fi + Cellular'] },
                'iPad Air': { mem: ['128','256'], col: ['Blue','Purple'], net: ['Wi-Fi', 'Wi-Fi + Cellular'] }
            },
            'Mac': { 
                'MacBook Pro': { mem: ['512','1TB'], col: ['Space Black','Silver'], net: ['–°—Ç–∞–Ω–¥–∞—Ä—Ç'] },
                'MacBook Air': { mem: ['256','512'], col: ['Starlight','Midnight'], net: ['–°—Ç–∞–Ω–¥–∞—Ä—Ç'] }
            },
            'Watch': { 
                'Series 10': { mem: ['42mm','46mm'], col: ['Black','Silver'], net: ['GPS','Cellular'] },
                'Ultra 2': { mem: ['49mm'], col: ['Titanium'], net: ['Cellular'] }
            }
        };

        const countries = [
            { name: '–°–®–ê', flag: 'üá∫üá∏' }, { name: '–û–ê–≠', flag: 'üá¶üá™' },
            { name: '–ö–∏—Ç–∞–π', flag: 'üá®üá≥' }, { name: '–Ø–ø–æ–Ω–∏—è', flag: 'üáØüáµ' },
            { name: '–ï–≤—Ä–æ–ø–∞ / –†–°–¢', flag: 'üá™üá∫' }
        ];

        // -------------------------------------------------------------
        // 2. –°–ò–°–¢–ï–ú–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // -------------------------------------------------------------
        let sel = { mode: '', cat: '', mod: '', mem: '', col: '', net: '', ctry: '', final_text: '' };
        let history = [];
        const userId = tg.initDataUnsafe.user?.id;
        
        // -------------------------------------------------------------
        // 3. –ó–ê–ü–£–°–ö –ò –ü–†–û–í–ï–†–ö–ê –†–û–õ–ò
        // -------------------------------------------------------------
        function init() {
            const savedRole = localStorage.getItem('user_role');
            if (!savedRole) {
                showScreen('screen-welcome');
            } else {
                updateInterface(savedRole);
                showScreen('screen-lk');
            }
        }

        function setRole(role) {
            if (role === 'seller' && !sellers.includes(userId)) {
                return alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –í–∞—à ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤.");
            }
            localStorage.setItem('user_role', role);
            updateInterface(role);
            showScreen('screen-lk');
        }

        function updateInterface(role) {
            document.getElementById('user-name').innerText = "–õ–ö - " + (tg.initDataUnsafe.user?.first_name || "Maxim");
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            document.getElementById('btn-price').style.display = (role === 'seller') ? 'block' : 'none';
        }

        // -------------------------------------------------------------
        // 4. –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –≠–ö–†–ê–ù–ê–ú
        // -------------------------------------------------------------
        function showScreen(id) {
            ['screen-welcome', 'screen-lk', 'screen-flow', 'screen-confirm', 'screen-price'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function switchTab(el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }

        function goBack() {
            let last = history.pop();
            if (last === 'lk') showScreen('screen-lk');
            else if (last === 'cat') renderCats();
            else if (last === 'mod') renderMods();
            else if (last === 'mem') renderMem();
            else if (last === 'col') renderCol();
            else if (last === 'net') renderNet();
        }

        // -------------------------------------------------------------
        // 5. –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –¢–û–í–ê–†–ê
        // -------------------------------------------------------------
        function startFlow(mode) {
            sel.mode = mode;
            history = ['lk'];
            renderCats();
            showScreen('screen-flow');
        }

        function renderCats() {
            let h = '';
            for (let c in catalog) h += `<button class="main-btn btn-white" onclick="selCat('${c}')">${c}</button>`;
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è";
        }

        function selCat(c) { sel.cat = c; history.push('cat'); renderMods(); }

        function renderMods() {
            let h = '';
            for (let m in catalog[sel.cat]) h += `<button class="main-btn btn-white" onclick="selMod('${m}')">${m}</button>`;
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–ú–æ–¥–µ–ª—å";
        }

        function selMod(m) { sel.mod = m; history.push('mod'); renderMem(); }

        function renderMem() {
            let h = '';
            catalog[sel.cat][sel.mod].mem.forEach(m => h += `<button class="main-btn btn-white" onclick="selMem('${m}')">${m} –ì–±</button>`);
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–ü–∞–º—è—Ç—å";
        }

        function selMem(m) { sel.mem = m; history.push('mem'); renderCol(); }

        function renderCol() {
            let h = '';
            catalog[sel.cat][sel.mod].col.forEach(c => h += `<button class="main-btn btn-white" onclick="selCol('${c}')">${c}</button>`);
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–¶–≤–µ—Ç";
        }

        function selCol(c) { sel.col = c; history.push('col'); renderNet(); }

        function renderNet() {
            let h = '';
            let nets = catalog[sel.cat][sel.mod].net || ['–°—Ç–∞–Ω–¥–∞—Ä—Ç'];
            nets.forEach(n => h += `<button class="main-btn btn-white" onclick="selNet('${n}')">${n}</button>`);
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–°–≤—è–∑—å";
        }

        function selNet(n) { sel.net = n; history.push('net'); renderCtry(); }

        function renderCtry() {
            let h = '';
            countries.forEach(c => {
                h += `<button class="main-btn btn-white" onclick="finishFlow('${c.name} ${c.flag}')">${c.flag} ${c.name}</button>`;
            });
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–†–µ–≥–∏–æ–Ω";
        }

        // -------------------------------------------------------------
        // 6. –ó–ê–í–ï–†–®–ï–ù–ò–ï: –ü–û–ö–£–ü–ö–ê –ò–õ–ò –ü–†–û–î–ê–ñ–ê
        // -------------------------------------------------------------
        function finishFlow(ctry) {
            sel.ctry = ctry;
            const product = `${sel.mod} ${sel.mem}Gb ${sel.col} (${sel.net}) [${sel.ctry}]`;

            if (sel.mode === 'buy') {
                // –õ–û–ì–ò–ö–ê –ü–û–ö–£–ü–ê–¢–ï–õ–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ "–ü–µ—Ä–≤—ã–π —Ä–∞–∑?"
                sel.final_text = "–ó–ê–ö–ê–ó: " + product;
                const hasAgreed = localStorage.getItem('rules_agreed');
                
                if (hasAgreed) {
                    finalSubmit(); // –ï—Å–ª–∏ —É–∂–µ —Å–æ–≥–ª–∞—à–∞–ª—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
                } else {
                    document.getElementById('summary-text').innerText = sel.final_text;
                    showScreen('screen-confirm'); // –ï—Å–ª–∏ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞
                }

            } else {
                // –õ–û–ì–ò–ö–ê –ü–†–û–î–ê–í–¶–ê: –ò–¥–µ–º –≤–≤–æ–¥–∏—Ç—å —Ü–µ–Ω—É
                document.getElementById('price-product-name').innerText = product;
                showScreen('screen-price');
            }
        }

        function finalSubmit() {
            localStorage.setItem('rules_agreed', 'true'); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–æ–≥–ª–∞—Å–∏–µ
            tg.sendData(sel.final_text);
            tg.close();
        }

        function finishPrice() {
            const price = document.getElementById('price-input').value;
            if (!price) return alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É!");
            
            const product = document.getElementById('price-product-name').innerText;
            const result = `–ü–†–ê–ô–°: ${product} - –¶–µ–Ω–∞: ${price}—Ä`;
            tg.sendData(result);
            tg.close();
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>
