<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –î–ò–ó–ê–ô–ù V5.1 (–ö–Ω–æ–ø–∫–∞ —à–∞–±–ª–æ–Ω–∞) --- */
        :root {
            --bg-color: var(--tg-theme-bg-color, #f2f2f7);
            --text-color: var(--tg-theme-text-color, #000000);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #8e8e93);
            --danger: #ff3b30;
            --success: #34c759;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 16px 16px 120px 16px; 
            -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .screen.active { display: block; opacity: 1; }
        .hidden { display: none !important; }

        .header { 
            text-align: center; margin-bottom: 20px; 
            font-size: 22px; font-weight: 700;
        }

        .card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            text-align: center; 
            margin-bottom: 20px;
        }

        .main-btn { 
            width: 100%; padding: 14px; 
            border-radius: 12px; border: none; 
            font-size: 16px; font-weight: 600; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 8px; margin-bottom: 10px; 
            opacity: 0; 
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .main-btn:active { transform: scale(0.98); opacity: 0.8; }
        
        .btn-primary { background: var(--accent); color: var(--accent-text); }
        .btn-outline { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--hint); } 
        /* –ó–µ–ª–µ–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è Excel */
        .btn-excel { background: var(--success); color: white; border: none; } 
        .btn-back { background: var(--bg-color); color: var(--text-color); width: 30%; font-size: 22px; margin-bottom: 0;} 

        .list-options { display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        .list-options .main-btn { width: 100%; text-align: center; margin: 0; min-height: 50px; }

        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 12px 16px 30px 16px; 
            background: var(--card-bg);
            border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex; gap: 10px; z-index: 9999;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px); 
        }

        .offer-card { 
            background: var(--card-bg); border-radius: 16px; padding: 16px; 
            margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
            opacity: 0; animation: popIn 0.4s ease forwards;
        }
        
        .offer-price { font-size: 18px; font-weight: 700; }
        .offer-seller { font-size: 12px; color: var(--hint); }
        .btn-buy-small { 
            background: var(--accent); color: white; border: none; padding: 8px 16px; 
            border-radius: 8px; font-weight: 600; font-size: 14px;
            display: flex; align-items: center; gap: 5px;
        }

        .input-price { 
            width: 100%; padding: 10px; font-size: 24px; font-weight: bold; 
            border: none; border-bottom: 2px solid var(--accent); 
            background: transparent; color: var(--text-color); 
            text-align: center; outline: none; margin: 20px 0;
        }

        .debug-box { font-size: 10px; color: var(--hint); text-align: center; margin-top: 10px; opacity: 0.5; }
        .admin-badge { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;}
    </style>
</head>
<body>
    <div id="app">
        
        <div id="screen-welcome" class="screen active">
            <h2 class="header">–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω üì±</h2>
            <div class="card">
                <p style="margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</p>
                <button class="main-btn btn-primary" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn btn-outline" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
            <div class="debug-box">ID: <span id="debug-id">...</span></div>
        </div>

        <div id="screen-lk" class="screen">
            <h2 class="header" id="user-name">–ú–µ–Ω—é</h2>
            <div class="card">
                <button class="main-btn btn-primary" id="btn-buy" onclick="startFlow()">üîç –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                
                <button class="main-btn btn-primary" id="btn-price" onclick="startFlow()">üí∞ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É (–ø–æ—à—Ç—É—á–Ω–æ)</button>
                
                <button class="main-btn btn-excel" id="btn-template" onclick="requestTemplate()">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω (Excel)</button>
            </div>
            <button style="margin-top: 20px; background: transparent; color: var(--danger); border:none; width:100%; font-size:14px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:5px;" onclick="resetRole()">üö™ –í—ã–π—Ç–∏ (–°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å)</button>
        </div>

        <div id="screen-flow" class="screen">
            <h2 id="flow-title" class="header">–í—ã–±–æ—Ä</h2>
            <div id="flow-content" class="list-options"></div> 
            <div class="bottom-bar">
                <button class="main-btn btn-back" onclick="goBack()">‚¨ÖÔ∏è</button>
                <div style="width: 100%; display:flex; align-items:center; justify-content:center; color: var(--hint); font-size: 12px;">–®–∞–≥ –Ω–∞–∑–∞–¥</div>
            </div>
        </div>

        <div id="screen-offers" class="screen">
            <h2 class="header">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è üìã</h2>
            <div id="offers-list"></div>
            <div class="bottom-bar">
                <button class="main-btn btn-back" style="width: 100%" onclick="showScreen('screen-flow')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</button>
            </div>
        </div>

        <div id="screen-price" class="screen">
            <h2 class="header">–í–∞—à–∞ —Ü–µ–Ω–∞ üè∑Ô∏è</h2>
            <div class="card">
                <p id="price-product-name" style="color:var(--hint)"></p>
                <input type="number" id="price-input" class="input-price" placeholder="‚ÇΩ">
            </div>
            <div class="bottom-bar">
                <button class="main-btn btn-back" onclick="showScreen('screen-flow')">‚¨ÖÔ∏è</button>
                <button class="main-btn btn-primary" style="margin-bottom: 0;" onclick="finishPrice()">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        const csvData = `
iPhone 16e, 128 GB, Black, Dual Physical SIM
iPhone 16e, 256 GB, Black, Dual Physical SIM
iPhone 16e, 512 GB, Black, Dual Physical SIM
iPhone 16e, 128 GB, White, Dual Physical SIM
iPhone 16e, 256 GB, White, Dual Physical SIM
iPhone 16e, 512 GB, White, Dual Physical SIM
iPhone 16e, 128 GB, Black, Physical + eSIM
iPhone 16e, 256 GB, Black, Physical + eSIM
iPhone 16e, 512 GB, Black, Physical + eSIM
iPhone 16e, 128 GB, White, Physical + eSIM
iPhone 16e, 256 GB, White, Physical + eSIM
iPhone 16e, 512 GB, White, Physical + eSIM
iPhone 16, 128 GB, Black, Dual Physical SIM
iPhone 16, 256 GB, Black, Dual Physical SIM
iPhone 16, 512 GB, Black, Dual Physical SIM
iPhone 16, 128 GB, White, Dual Physical SIM
iPhone 16, 256 GB, White, Dual Physical SIM
iPhone 16, 512 GB, White, Dual Physical SIM
iPhone 16, 128 GB, Pink, Dual Physical SIM
iPhone 16, 256 GB, Pink, Dual Physical SIM
iPhone 16, 512 GB, Pink, Dual Physical SIM
iPhone 16, 128 GB, Teal, Dual Physical SIM
iPhone 16, 256 GB, Teal, Dual Physical SIM
iPhone 16, 512 GB, Teal, Dual Physical SIM
iPhone 16, 128 GB, Ultramarine, Dual Physical SIM
iPhone 16, 256 GB, Ultramarine, Dual Physical SIM
iPhone 16, 512 GB, Ultramarine, Dual Physical SIM
iPhone 16, 128 GB, Black, Physical + eSIM
iPhone 16, 256 GB, Black, Physical + eSIM
iPhone 16, 512 GB, Black, Physical + eSIM
iPhone 16, 128 GB, White, Physical + eSIM
iPhone 16, 256 GB, White, Physical + eSIM
iPhone 16, 512 GB, White, Physical + eSIM
iPhone 16, 128 GB, Pink, Physical + eSIM
iPhone 16, 256 GB, Pink, Physical + eSIM
iPhone 16, 512 GB, Pink, Physical + eSIM
iPhone 16, 128 GB, Teal, Physical + eSIM
iPhone 16, 256 GB, Teal, Physical + eSIM
iPhone 16, 512 GB, Teal, Physical + eSIM
iPhone 16, 128 GB, Ultramarine, Physical + eSIM
iPhone 16, 256 GB, Ultramarine, Physical + eSIM
iPhone 16, 512 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 128 GB, Black, Dual Physical SIM
iPhone 16 Plus, 256 GB, Black, Dual Physical SIM
iPhone 16 Plus, 512 GB, Black, Dual Physical SIM
iPhone 16 Plus, 128 GB, White, Dual Physical SIM
iPhone 16 Plus, 256 GB, White, Dual Physical SIM
iPhone 16 Plus, 512 GB, White, Dual Physical SIM
iPhone 16 Plus, 128 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 256 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 512 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 128 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 256 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 512 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 128 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 256 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 512 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 128 GB, Black, Physical + eSIM
iPhone 16 Plus, 256 GB, Black, Physical + eSIM
iPhone 16 Plus, 512 GB, Black, Physical + eSIM
iPhone 16 Plus, 128 GB, White, Physical + eSIM
iPhone 16 Plus, 256 GB, White, Physical + eSIM
iPhone 16 Plus, 512 GB, White, Physical + eSIM
iPhone 16 Plus, 128 GB, Pink, Physical + eSIM
iPhone 16 Plus, 256 GB, Pink, Physical + eSIM
iPhone 16 Plus, 512 GB, Pink, Physical + eSIM
iPhone 16 Plus, 128 GB, Teal, Physical + eSIM
iPhone 16 Plus, 256 GB, Teal, Physical + eSIM
iPhone 16 Plus, 512 GB, Teal, Physical + eSIM
iPhone 16 Plus, 128 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 256 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 512 GB, Ultramarine, Physical + eSIM
iPhone 16 Pro, 128 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, White Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Desert Titanium, Physical + eSIM
        `;

        const admins = [464896073, 210419]; 
        const sellers = [464896073]; 
        
        const urlParams = new URLSearchParams(window.location.search);
        let myId = urlParams.get('uid') ? parseInt(urlParams.get('uid')) : tg.initDataUnsafe.user?.id;
        document.getElementById('debug-id').innerText = myId || "–ù–ï –û–ü–†–ï–î–ï–õ–ï–ù";

        const catalogData = csvData.trim().split('\n').map(row => row.split(',').map(s => s.trim()));
        const headers = ["üì± –ú–æ–¥–µ–ª—å", "üíæ –ü–∞–º—è—Ç—å", "üé® –¶–≤–µ—Ç", "üì≤ –°–∏–º-–∫–∞—Ä—Ç–∞"];

        let dbOffers = []; 
        try {
            const dataStr = urlParams.get('data');
            if (dataStr) dbOffers = JSON.parse(decodeURIComponent(dataStr));
        } catch (e) { console.error(e); }

        let currentSelection = [];
        let userRole = '';

        function init() {
            const role = localStorage.getItem('user_role');
            if(!role) showScreen('screen-welcome');
            else { userRole = role; updateInterface(role); showScreen('screen-lk'); }
        }

        function setRole(role) {
            const isAllowed = sellers.includes(myId) || admins.includes(myId);
            if(role === 'seller' && !isAllowed) return alert("‚õîÔ∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –í–∞—à ID: " + myId);
            localStorage.setItem('user_role', role);
            userRole = role;
            updateInterface(role);
            showScreen('screen-lk');
        }

        function resetRole() { localStorage.removeItem('user_role'); location.reload(); }

        function updateInterface(role) {
            const userName = tg.initDataUnsafe.user?.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            const isAdmin = admins.includes(myId);
            const badge = isAdmin ? ' <span class="admin-badge">ADMIN</span>' : '';
            document.getElementById('user-name').innerHTML = userName + badge;
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            
            // --- –õ–û–ì–ò–ö–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –î–õ–Ø –ü–†–û–î–ê–í–¶–ê ---
            if (role === 'seller') {
                document.getElementById('btn-price').style.display = 'block';
                document.getElementById('btn-template').style.display = 'block';
            } else {
                document.getElementById('btn-price').style.display = 'none';
                document.getElementById('btn-template').style.display = 'none';
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            window.scrollTo(0,0);
            document.getElementById(id).classList.add('active');
        }

        function requestTemplate() {
            // –≠–¢–ê –§–£–ù–ö–¶–ò–Ø –®–õ–ï–¢ –°–ò–ì–ù–ê–õ –ë–û–¢–£
            tg.sendData("REQ_TEMPLATE");
        }

        function startFlow() {
            currentSelection = [];
            renderStep(0);
            showScreen('screen-flow');
        }

        function goBack() {
            if (currentSelection.length > 0) {
                currentSelection.pop();
                renderStep(currentSelection.length);
            } else {
                showScreen('screen-lk');
            }
        }

        function renderStep(stepIndex) {
            if (stepIndex >= headers.length) {
                finishFlow();
                return;
            }

            document.getElementById('flow-title').innerText = headers[stepIndex];
            
            const availableOptions = new Set();
            catalogData.forEach(row => {
                let match = true;
                for(let i=0; i < stepIndex; i++) {
                    if (row[i] !== currentSelection[i]) match = false;
                }
                if (match) availableOptions.add(row[stepIndex]);
            });

            let h = '';
            Array.from(availableOptions).sort().forEach((opt, index) => {
                const delay = index * 0.05; 
                h += `<button class="main-btn btn-outline" style="animation-delay: ${delay}s" onclick="makeSelection('${opt}')">${opt}</button>`;
            });
            document.getElementById('flow-content').innerHTML = h;
        }

        function makeSelection(value) {
            currentSelection.push(value);
            renderStep(currentSelection.length);
        }

        function finishFlow() {
            const productName = currentSelection.join(' '); 
            document.getElementById('price-product-name').innerText = productName;
            if (userRole === 'buyer') renderOffers(productName);
            else showScreen('screen-price');
        }

        function renderOffers(productName) {
            let h = '';
            const relevantOffers = dbOffers.filter(o => o.product === productName);
            relevantOffers.sort((a,b)=>a.price-b.price);

            if (relevantOffers.length === 0) {
                h = '<div style="text-align:center; padding:40px; color:var(--hint);">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç üòî</div>';
            } else {
                relevantOffers.forEach((o, index) => {
                    const delay = index * 0.1;
                    h += `
                    <div class="offer-card" style="animation-delay: ${delay}s">
                        <div class="offer-info">
                            <div class="offer-price">${o.price.toLocaleString()} ‚ÇΩ</div>
                            <div class="offer-seller">@${o.username}</div>
                        </div>
                        <button class="btn-buy-small" onclick="requestBuy('${o.id}', '${o.username}', '${o.price}', '${productName}')">üõçÔ∏è –ö—É–ø–∏—Ç—å</button>
                    </div>`;
                });
            }
            document.getElementById('offers-list').innerHTML = h;
            showScreen('screen-offers');
        }

        function requestBuy(sid, sname, price, pname) {
            tg.sendData(`REQ_BUY|${sid}|${sname}|${pname}|${price}`);
        }

        function finishPrice() {
            const p = document.getElementById('price-input').value;
            const pname = document.getElementById('price-product-name').innerText;
            if(!p) return alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");
            tg.sendData(`NEW_PRICE|${pname}|${p}`);
        }

        init();
    </script>
</body>
</html>
