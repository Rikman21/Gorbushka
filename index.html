<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f2f2f7; padding: 15px; color: #1c1c1e; }
        .hidden { display: none !important; }
        .header { text-align: center; margin-bottom: 15px; color: #007aff; font-size: 20px; font-weight: 600; }
        .card { background: white; border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .main-btn { padding: 18px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-yellow { background: #ffcc00; color: #000; }
        .btn-white { background: #fff; border: 1px solid #ddd; text-align: left; margin: 8px 0; display: block; }
        .back-btn { background: #ff3b30; color: white; margin-top: 15px; }
        .btn-reset { background: transparent; color: #8e8e93; border: none; font-size: 14px; margin-top: 10px; cursor: pointer; text-decoration: underline; }
        .offer-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .offer-info { text-align: left; }
        .offer-price { font-size: 18px; font-weight: bold; color: #34c759; }
        .offer-seller { font-size: 12px; color: #8e8e93; }
        .btn-buy-small { background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .input-price { width: 90%; padding: 15px; font-size: 24px; border-radius: 10px; border: 2px solid #007aff; text-align: center; margin-bottom: 15px; }
        .admin-badge { background: #ff3b30; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; vertical-align: middle; }
        .debug-box { font-size: 12px; color: #ff3b30; background: #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px dashed red;}
    </style>
</head>
<body>
    <div id="app">
        <div id="screen-welcome" class="hidden">
            <h2 class="header">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <div class="debug-box">–í–∞—à ID: <span id="debug-id">...</span></div>
            <div class="card">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:</p>
                <button class="main-btn btn-yellow" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn btn-white" style="text-align:center" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
        </div>

        <div id="screen-lk" class="hidden">
            <div class="card">
                <div id="user-name">–õ–ö</div>
                <button class="btn-reset" onclick="resetRole()">üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å (–í—ã–π—Ç–∏)</button>
            </div>
            <button class="main-btn btn-yellow" id="btn-buy" onclick="startFlow()">–ö—É–ø–∏—Ç—å</button>
            <button class="main-btn btn-yellow" id="btn-price" onclick="startFlow()">–ú–æ–π –ü—Ä–∞–π—Å</button>
        </div>

        <div id="screen-flow" class="hidden">
            <h2 id="flow-title" class="header">–í—ã–±–æ—Ä</h2>
            <div id="flow-content"></div>
            <button class="main-btn back-btn" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-offers" class="hidden">
            <h2 class="header">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
            <div id="offers-list"></div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-price" class="hidden">
            <h2 class="header">–¶–µ–Ω–∞</h2>
            <div class="card">
                <p id="price-product-name"></p>
                <input type="number" id="price-input" class="input-price" placeholder="–¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö">
                <button class="main-btn btn-yellow" onclick="finishPrice()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // ==========================================
        // üìä –í–ê–® –ö–ê–¢–ê–õ–û–ì (–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ò–ó –§–ê–ô–õ–ê)
        // ==========================================
        const csvData = `
iPhone 16e, 128 GB, Black, Dual Physical SIM
iPhone 16e, 256 GB, Black, Dual Physical SIM
iPhone 16e, 512 GB, Black, Dual Physical SIM
iPhone 16e, 128 GB, White, Dual Physical SIM
iPhone 16e, 256 GB, White, Dual Physical SIM
iPhone 16e, 512 GB, White, Dual Physical SIM
iPhone 16e, 128 GB, Black, Physical + eSIM
iPhone 16e, 256 GB, Black, Physical + eSIM
iPhone 16e, 512 GB, Black, Physical + eSIM
iPhone 16e, 128 GB, White, Physical + eSIM
iPhone 16e, 256 GB, White, Physical + eSIM
iPhone 16e, 512 GB, White, Physical + eSIM
iPhone 16, 128 GB, Black, Dual Physical SIM
iPhone 16, 256 GB, Black, Dual Physical SIM
iPhone 16, 512 GB, Black, Dual Physical SIM
iPhone 16, 128 GB, White, Dual Physical SIM
iPhone 16, 256 GB, White, Dual Physical SIM
iPhone 16, 512 GB, White, Dual Physical SIM
iPhone 16, 128 GB, Pink, Dual Physical SIM
iPhone 16, 256 GB, Pink, Dual Physical SIM
iPhone 16, 512 GB, Pink, Dual Physical SIM
iPhone 16, 128 GB, Teal, Dual Physical SIM
iPhone 16, 256 GB, Teal, Dual Physical SIM
iPhone 16, 512 GB, Teal, Dual Physical SIM
iPhone 16, 128 GB, Ultramarine, Dual Physical SIM
iPhone 16, 256 GB, Ultramarine, Dual Physical SIM
iPhone 16, 512 GB, Ultramarine, Dual Physical SIM
iPhone 16, 128 GB, Black, Physical + eSIM
iPhone 16, 256 GB, Black, Physical + eSIM
iPhone 16, 512 GB, Black, Physical + eSIM
iPhone 16, 128 GB, White, Physical + eSIM
iPhone 16, 256 GB, White, Physical + eSIM
iPhone 16, 512 GB, White, Physical + eSIM
iPhone 16, 128 GB, Pink, Physical + eSIM
iPhone 16, 256 GB, Pink, Physical + eSIM
iPhone 16, 512 GB, Pink, Physical + eSIM
iPhone 16, 128 GB, Teal, Physical + eSIM
iPhone 16, 256 GB, Teal, Physical + eSIM
iPhone 16, 512 GB, Teal, Physical + eSIM
iPhone 16, 128 GB, Ultramarine, Physical + eSIM
iPhone 16, 256 GB, Ultramarine, Physical + eSIM
iPhone 16, 512 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 128 GB, Black, Dual Physical SIM
iPhone 16 Plus, 256 GB, Black, Dual Physical SIM
iPhone 16 Plus, 512 GB, Black, Dual Physical SIM
iPhone 16 Plus, 128 GB, White, Dual Physical SIM
iPhone 16 Plus, 256 GB, White, Dual Physical SIM
iPhone 16 Plus, 512 GB, White, Dual Physical SIM
iPhone 16 Plus, 128 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 256 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 512 GB, Pink, Dual Physical SIM
iPhone 16 Plus, 128 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 256 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 512 GB, Teal, Dual Physical SIM
iPhone 16 Plus, 128 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 256 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 512 GB, Ultramarine, Dual Physical SIM
iPhone 16 Plus, 128 GB, Black, Physical + eSIM
iPhone 16 Plus, 256 GB, Black, Physical + eSIM
iPhone 16 Plus, 512 GB, Black, Physical + eSIM
iPhone 16 Plus, 128 GB, White, Physical + eSIM
iPhone 16 Plus, 256 GB, White, Physical + eSIM
iPhone 16 Plus, 512 GB, White, Physical + eSIM
iPhone 16 Plus, 128 GB, Pink, Physical + eSIM
iPhone 16 Plus, 256 GB, Pink, Physical + eSIM
iPhone 16 Plus, 512 GB, Pink, Physical + eSIM
iPhone 16 Plus, 128 GB, Teal, Physical + eSIM
iPhone 16 Plus, 256 GB, Teal, Physical + eSIM
iPhone 16 Plus, 512 GB, Teal, Physical + eSIM
iPhone 16 Plus, 128 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 256 GB, Ultramarine, Physical + eSIM
iPhone 16 Plus, 512 GB, Ultramarine, Physical + eSIM
iPhone 16 Pro, 128 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Black Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, White Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 256 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 512 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 1 TB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro, 128 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Black Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, White Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, White Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Natural Titanium, Physical + eSIM
iPhone 16 Pro, 128 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 256 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 512 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro, 1 TB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Black Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, White Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Natural Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 512 GB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 1 TB, Desert Titanium, Dual Physical SIM
iPhone 16 Pro Max, 256 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Black Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, White Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Natural Titanium, Physical + eSIM
iPhone 16 Pro Max, 256 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 512 GB, Desert Titanium, Physical + eSIM
iPhone 16 Pro Max, 1 TB, Desert Titanium, Physical + eSIM
        `;
        // ==========================================

        const admins = [464896073, 210419]; 
        const sellers = [464896073]; 
        
        // --- –õ–æ–≥–∏–∫–∞ ID ---
        const urlParams = new URLSearchParams(window.location.search);
        let myId = urlParams.get('uid') ? parseInt(urlParams.get('uid')) : tg.initDataUnsafe.user?.id;
        document.getElementById('debug-id').innerText = myId || "–ù–ï –û–ü–†–ï–î–ï–õ–ï–ù";

        // --- –ü–∞—Ä—Å–∏–Ω–≥ CSV ---
        const catalogData = csvData.trim().split('\n').map(row => row.split(',').map(s => s.trim()));
        
        // --- –ó–ê–ì–û–õ–û–í–ö–ò –®–ê–ì–û–í (–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–¥ –≤–∞—à —Ñ–∞–π–ª) ---
        const headers = ["–ú–æ–¥–µ–ª—å", "–ü–∞–º—è—Ç—å", "–¶–≤–µ—Ç", "–°–∏–º-–∫–∞—Ä—Ç–∞"];

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã —Ü–µ–Ω ---
        let dbOffers = []; 
        try {
            const dataStr = urlParams.get('data');
            if (dataStr) dbOffers = JSON.parse(decodeURIComponent(dataStr));
        } catch (e) { console.error(e); }

        let currentSelection = [];
        let userRole = '';

        function init() {
            const role = localStorage.getItem('user_role');
            if(!role) showScreen('screen-welcome');
            else { userRole = role; updateInterface(role); showScreen('screen-lk'); }
        }

        function setRole(role) {
            const isAllowed = sellers.includes(myId) || admins.includes(myId);
            if(role === 'seller' && !isAllowed) return alert("‚õîÔ∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –í–∞—à ID: " + myId);
            localStorage.setItem('user_role', role);
            userRole = role;
            updateInterface(role);
            showScreen('screen-lk');
        }

        function resetRole() { localStorage.removeItem('user_role'); location.reload(); }

        function updateInterface(role) {
            const userName = tg.initDataUnsafe.user?.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            const isAdmin = admins.includes(myId);
            const badge = isAdmin ? ' <span class="admin-badge">ADMIN</span>' : '';
            document.getElementById('user-name').innerHTML = "–õ–ö: " + userName + badge;
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            document.getElementById('btn-price').style.display = (role === 'seller') ? 'block' : 'none';
        }

        function showScreen(id) {
            ['screen-welcome', 'screen-lk', 'screen-flow', 'screen-offers', 'screen-price'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê ---
        function startFlow() {
            currentSelection = [];
            renderStep(0);
            showScreen('screen-flow');
        }

        function goBack() {
            if (currentSelection.length > 0) {
                currentSelection.pop();
                renderStep(currentSelection.length);
            } else {
                showScreen('screen-lk');
            }
        }

        function renderStep(stepIndex) {
            if (stepIndex >= headers.length) {
                finishFlow();
                return;
            }

            document.getElementById('flow-title').innerText = "–í—ã–±–µ—Ä–∏—Ç–µ: " + headers[stepIndex];
            
            const availableOptions = new Set();
            catalogData.forEach(row => {
                let match = true;
                for(let i=0; i < stepIndex; i++) {
                    if (row[i] !== currentSelection[i]) match = false;
                }
                if (match) availableOptions.add(row[stepIndex]);
            });

            let h = '';
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤–æ (–ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –∏–ª–∏ —Ä–∞–∑–º–µ—Ä—É)
            Array.from(availableOptions).sort().forEach(opt => {
                h += `<button class="main-btn btn-white" onclick="makeSelection('${opt}')">${opt}</button>`;
            });
            document.getElementById('flow-content').innerHTML = h;
        }

        function makeSelection(value) {
            currentSelection.push(value);
            renderStep(currentSelection.length);
        }

        function finishFlow() {
            const productName = currentSelection.join(' '); 
            document.getElementById('price-product-name').innerText = productName;
            if (userRole === 'buyer') renderOffers(productName);
            else showScreen('screen-price');
        }

        // --- –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¶–ï–ù ---
        function renderOffers(productName) {
            let h = '';
            const relevantOffers = dbOffers.filter(o => o.product === productName);
            relevantOffers.sort((a,b)=>a.price-b.price);

            if (relevantOffers.length === 0) {
                h = '<div style="text-align:center; padding:20px; color:#8e8e93;">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–∞ —ç—Ç—É –º–æ–¥–µ–ª—å ü§∑‚Äç‚ôÇÔ∏è</div>';
            } else {
                relevantOffers.forEach(o => {
                    h += `
                    <div class="offer-card">
                        <div class="offer-info">
                            <div class="offer-price">${o.price.toLocaleString()} ‚ÇΩ</div>
                            <div class="offer-seller">@${o.username}</div>
                        </div>
                        <button class="btn-buy-small" onclick="requestBuy('${o.id}', '${o.username}', '${o.price}', '${productName}')">–ö—É–ø–∏—Ç—å</button>
                    </div>`;
                });
            }
            document.getElementById('offers-list').innerHTML = h;
            showScreen('screen-offers');
        }

        function requestBuy(sid, sname, price, pname) {
            tg.sendData(`REQ_BUY|${sid}|${sname}|${pname}|${price}`);
        }

        function finishPrice() {
            const p = document.getElementById('price-input').value;
            const pname = document.getElementById('price-product-name').innerText;
            if(!p) return alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");
            tg.sendData(`NEW_PRICE|${pname}|${p}`);
        }

        init();
    </script>
</body>
</html>
