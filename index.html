<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
               background-color: #f2f2f7; padding: 15px; color: #1c1c1e; }
        
        .header { text-align: center; margin-bottom: 15px; color: #007aff; font-size: 20px; font-weight: 600; }
        .card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .balance { font-size: 32px; font-weight: bold; margin: 10px 0; color: #000; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .main-btn { padding: 18px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-yellow { background: #ffcc00; color: #000; }
        .btn-white { background: #fff; border: 1px solid #ddd; text-align: left; margin: 8px 0; width: 100%; display: block; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-white:active { background: #e5e5ea; }
        .back-btn { background: #ff3b30; color: white; width: 100%; margin-top: 15px; }
        
        .hidden { display: none !important; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å) */
        .offer-card { 
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .offer-info { text-align: left; }
        .offer-price { font-size: 18px; font-weight: bold; color: #34c759; }
        .offer-seller { font-size: 14px; color: #8e8e93; margin-top: 4px; }
        .btn-buy-small { 
            background: #007aff; color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; font-weight: 600; cursor: pointer; 
        }
        
        .input-price { width: 90%; padding: 15px; font-size: 24px; border-radius: 10px; border: 2px solid #007aff; text-align: center; margin-bottom: 15px; outline: none; }
    </style>
</head>
<body>
    <div id="app">
        <div id="screen-welcome" class="hidden">
            <h2 class="header">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <div class="card">
                <p style="color: #8e8e93; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Å—Ç–∞—Ç—É—Å:</p>
                <button class="main-btn btn-yellow" style="width:100%; margin-bottom:10px;" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn btn-white" style="width:100%; text-align:center;" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
        </div>

        <div id="screen-lk" class="hidden">
            <div class="card">
                <div id="user-name" style="color: #8e8e93; font-size: 14px;">–õ–ö - –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="balance">0‚ÇΩ</div>
            </div>
            <div class="grid">
                <button id="btn-buy" class="main-btn btn-yellow" onclick="startFlow('buy')">–ö—É–ø–∏—Ç—å</button>
                <button id="btn-price" class="main-btn btn-yellow" onclick="startFlow('sell')">–ú–æ–π –ü—Ä–∞–π—Å</button>
            </div>
        </div>

        <div id="screen-flow" class="hidden">
            <h2 id="flow-title" class="header">–í—ã–±–æ—Ä</h2>
            <div id="flow-content"></div>
            <button class="main-btn back-btn" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-offers" class="hidden">
            <h2 class="header">–õ—É—á—à–∏–µ —Ü–µ–Ω—ã</h2>
            <p id="offers-subtitle" style="text-align:center; color:#8e8e93; font-size:12px; margin-bottom:15px;"></p>
            <div id="offers-list"></div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-price" class="hidden">
            <h2 class="header">–í–∞—à–∞ —Ü–µ–Ω–∞</h2>
            <div class="card">
                <p id="price-product-name" style="font-weight:bold; font-size:14px; margin-bottom:10px;"></p>
                <input type="number" id="price-input" class="input-price" placeholder="100000">
                <p style="color: #8e8e93; font-size:12px;">–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö</p>
                <button class="main-btn btn-yellow" style="width:100%" onclick="finishPrice()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
            <button class="main-btn back-btn" onclick="showScreen('screen-flow')">‚¨Ö –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // --- –í–ê–ñ–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ---
        
        // 1. –í–ü–ò–®–ò–¢–ï –°–Æ–î–ê –°–í–û–ô ID (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –ø—Ä–æ–¥–∞–≤–µ—Ü)
        const sellers = [@GaFoks]; 
        
        const userId = tg.initDataUnsafe.user?.id;

        // 2. –ò–ú–ò–¢–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• (–í–ü–ò–®–ò–¢–ï –°–Æ–î–ê –°–í–û–ô ID –≤–º–µ—Å—Ç–æ 123456789, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –∑–∞–∫–∞–∑—ã)
        const mockOffers = [
            { id: @GaFoks, username: 'My_Store', price: 105000, rating: '‚≠êÔ∏è 4.9' },
            { id: 555555555, username: 'Apple_Rostov', price: 106500, rating: '‚≠êÔ∏è 5.0' },
            { id: 777777777, username: 'Ivan_Gadget', price: 104000, rating: '‚≠êÔ∏è 4.8' }
        ];

        // --- –ö–ê–¢–ê–õ–û–ì ---
        const catalog = {
            'iPhone': {
                'iPhone 16 Pro Max': { mem: ['256','512','1TB'], col: ['Black','Silver','Desert'], net: ['Sim + eSim', '2 Sim', 'eSim Only'] },
                'iPhone 16 Pro': { mem: ['128','256','512'], col: ['Black','Silver','Desert'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 16': { mem: ['128','256','512'], col: ['Black','Blue','Pink'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 15': { mem: ['128','256'], col: ['Black','Blue','Yellow'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 14': { mem: ['128','256'], col: ['Black','Purple','Blue'], net: ['Sim + eSim', '2 Sim'] },
                'iPhone 13': { mem: ['128','256'], col: ['Midnight','Starlight','Blue'], net: ['1 Sim'] },
                'iPhone 11': { mem: ['64','128'], col: ['Black','Silver'], net: ['1 Sim'] }
            },
            'iPad': { 
                'iPad Pro M4': { mem: ['256','512'], col: ['Space Gray','Silver'], net: ['Wi-Fi', 'Wi-Fi + Cellular'] }
            },
            'Mac': { 
                'MacBook Pro': { mem: ['512','1TB'], col: ['Space Black','Silver'], net: ['–°—Ç–∞–Ω–¥–∞—Ä—Ç'] }
            }
        };

        const countries = [
            { name: '–°–®–ê', flag: 'üá∫üá∏' }, { name: '–û–ê–≠', flag: 'üá¶üá™' },
            { name: '–ö–∏—Ç–∞–π', flag: 'üá®üá≥' }, { name: '–Ø–ø–æ–Ω–∏—è', flag: 'üáØüáµ' },
            { name: '–†–°–¢', flag: 'üá∑üá∫' }
        ];

        let sel = { mode: '', cat: '', mod: '', mem: '', col: '', net: '', ctry: '', productName: '' };
        let history = [];

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        function init() {
            const savedRole = localStorage.getItem('user_role');
            if (!savedRole) { showScreen('screen-welcome'); } 
            else { updateInterface(savedRole); showScreen('screen-lk'); }
        }

        function setRole(role) {
            if (role === 'seller' && !sellers.includes(userId)) return alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (–ù–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤)");
            localStorage.setItem('user_role', role);
            updateInterface(role);
            showScreen('screen-lk');
        }

        function updateInterface(role) {
            document.getElementById('user-name').innerText = "–õ–ö - " + (tg.initDataUnsafe.user?.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å");
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            document.getElementById('btn-price').style.display = (role === 'seller') ? 'block' : 'none';
        }

        function showScreen(id) {
            ['screen-welcome', 'screen-lk', 'screen-flow', 'screen-offers', 'screen-price'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function goBack() {
            let last = history.pop();
            if (last === 'lk') showScreen('screen-lk');
            else if (last === 'cat') renderCats();
            else if (last === 'mod') renderMods();
            else if (last === 'mem') renderMem();
            else if (last === 'col') renderCol();
            else if (last === 'net') renderNet();
        }

        // --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê ---
        function startFlow(mode) {
            sel.mode = mode;
            history = ['lk'];
            renderCats();
            showScreen('screen-flow');
        }

        function renderCats() {
            let h = '';
            for (let c in catalog) h += `<button class="main-btn btn-white" onclick="selCat('${c}')">${c}</button>`;
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è";
        }
        function selCat(c) { sel.cat = c; history.push('cat'); renderMods(); }
        function renderMods() {
            let h = '';
            for (let m in catalog[sel.cat]) h += `<button class="main-btn btn-white" onclick="selMod('${m}')">${m}</button>`;
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–ú–æ–¥–µ–ª—å";
        }
        function selMod(m) { sel.mod = m; history.push('mod'); renderMem(); }
        function renderMem() {
            let h = '';
            catalog[sel.cat][sel.mod].mem.forEach(m => h += `<button class="main-btn btn-white" onclick="selMem('${m}')">${m} –ì–±</button>`);
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–ü–∞–º—è—Ç—å";
        }
        function selMem(m) { sel.mem = m; history.push('mem'); renderCol(); }
        function renderCol() {
            let h = '';
            catalog[sel.cat][sel.mod].col.forEach(c => h += `<button class="main-btn btn-white" onclick="selCol('${c}')">${c}</button>`);
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–¶–≤–µ—Ç";
        }
        function selCol(c) { sel.col = c; history.push('col'); renderNet(); }
        function renderNet() {
            let h = '';
            let nets = catalog[sel.cat][sel.mod].net || ['–°—Ç–∞–Ω–¥–∞—Ä—Ç'];
            nets.forEach(n => h += `<button class="main-btn btn-white" onclick="selNet('${n}')">${n}</button>`);
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–°–≤—è–∑—å";
        }
        function selNet(n) { sel.net = n; history.push('net'); renderCtry(); }
        function renderCtry() {
            let h = '';
            countries.forEach(c => {
                h += `<button class="main-btn btn-white" onclick="finishFlow('${c.name} ${c.flag}')">${c.flag} ${c.name}</button>`;
            });
            document.getElementById('flow-content').innerHTML = h;
            document.getElementById('flow-title').innerText = "–†–µ–≥–∏–æ–Ω";
        }

        // --- –§–ò–ù–ê–õ ---
        function finishFlow(ctry) {
            sel.ctry = ctry;
            const product = `${sel.mod} ${sel.mem}Gb ${sel.col} (${sel.net}) [${sel.ctry}]`;
            sel.productName = product;

            if (sel.mode === 'buy') {
                renderOffers(product);
            } else {
                document.getElementById('price-product-name').innerText = product;
                showScreen('screen-price');
            }
        }

        // --- –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô ---
        function renderOffers(productName) {
            document.getElementById('offers-subtitle').innerText = productName;
            let h = '';
            const sortedOffers = mockOffers.sort((a, b) => a.price - b.price);

            sortedOffers.forEach(offer => {
                h += `
                <div class="offer-card">
                    <div class="offer-info">
                        <div class="offer-price">${offer.price.toLocaleString()} ‚ÇΩ</div>
                        <div class="offer-seller">üë§ @${offer.username}</div>
                        <div style="font-size:12px; color:#ffcc00">${offer.rating}</div>
                    </div>
                    <button class="btn-buy-small" onclick="requestBuy(${offer.id}, '${offer.username}', ${offer.price})">–ö—É–ø–∏—Ç—å</button>
                </div>`;
            });

            document.getElementById('offers-list').innerHTML = h;
            showScreen('screen-offers');
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ü–†–û–î–ê–í–¶–£ ---
        function requestBuy(sellerId, sellerUsername, price) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–¥ –±–æ—Ç—É
            const data = `REQ_BUY|${sellerId}|${sellerUsername}|${sel.productName}|${price}`;
            tg.sendData(data);
            tg.close();
        }

        // --- –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –¶–ï–ù–´ ---
        function finishPrice() {
            const price = document.getElementById('price-input').value;
            if (!price) return alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");
            tg.sendData(`NEW_PRICE|${document.getElementById('price-product-name').innerText}|${price}`);
            tg.close();
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>

